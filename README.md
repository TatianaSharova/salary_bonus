# **Salary Bonus**
Сервис для расчета премирования сотрудников проектного отдела. Программа оценивает каждый проект определенным количеством баллов, потом полученные за проект баллы распределяются по кварталам. Так мы узнаем, сколько баллов заработал проектировщик в течение каждого квартала. Все баллы, превышающие рабочий план, становятся премиальными баллами, и за них выплачивается премия.


### _Как происходит расчет баллов:_                                                          

Для расчета баллов программа берет данные из рабочей таблицы с архивом проектов "Таблица проектов".

Полученные балы зависят от нескольких критериев: сложность проекта, тип объекта, количество направлений АСПТ (и другие АПТ), наличие ПС, ОС, СОУЭ, сетей, автоматизации систем вентиляции, наличие СОТ(количество камер), наличие СКУД(количество точек доступа), является ли объект культурным наследием, выполнен ли проект до дедлайна.

Все функции для расчета баллов находятся в файле counting_points.py.

Для начала проект проверяется на наличие необходимых для расчета характеристик: наименование объекта, шифр исп, дата начала проекта, сложность. Если какая-то из этих характеристик не заполнена, расчет баллов для проекта не осуществляется. Остальные критерии, перечисленные выше, являются добавочными и могут быть не заполнены.

Если необходимые характеристики заполнены, переходим к расчету баллов:

**_Сложность проекта:_**                                                         

Сложность проекта берется из таблицы проектов (определяется ГИПом). Также есть функция для определения сложности проекта (set_project_complexity, пока в доработке). Минимальная сложность 1, максимальная 5.

**_Количество направлений:_**                                                          
Проверяем количество направлений (функция check_amount_directions)
Баллы зависят от сложности проекта и количества направлений. Зависимость показана в таблице:

| Сложность  | 1-2 | 3-4 | 5-6 | 7-8 | 9-12 | 13-20 |
| ---------- | --- | --- | --- | --- | ---- | ----- |
|     1      |  1  |  1  | 1,5 |  2  |  2,5 |   3   |
|     2      |  1  | 1,5 |  2  |  2  |  3   |  3,5  |
|     3      | 1,5 |  2  | 2,5 | 2,5 |  3,5 |   4   |
|     4      |  2  | 2,5 |  3  |  3  |  4   |   5   |
|     5      |  4  |  4  |  4  |  5  |  6   |   8   |

Если направлений больше 20, баллы вычисляются по формуле:                                
(количество направлений/(8.5-сложность) + сложность/2)

**_ПС, СОУЭ, ОС, автоматизация систем вентиляции:_**                                                        
Проверяем наличие ПС, СОУЭ, ОС, автоматизации систем вентиляции (функция check_square):
Баллы за эти характеристики суммируются.
Если храктеристика присутствует, то для нее баллы рассчитываются исходя из сложности и площади защищаемых помещений:

| Сложность  | до 400 м^2 | 400-1000 | 1000-3000 | 3000-10000 | более 10000 |
| ---------- | ---------- | -------- | --------- | ---------- | ----------- |
|     1      |     1      |    1,5   |     2     |     2,5    |      3      |
|     2      |     2      |    2,5   |     3     |     3,5    |      5      |
|     3      |     2      |     3    |    3,5    |      4     |      8      |
|     4      |     3      |     4    |    4,5    |      5     |      10     |
|     5      |     4      |    4,5   |     5     |     5,5    |      12     |

**_СОТ, СКУД:_**                                                 
Проверяем наличие СОТ, СКУД (функция check_sot_skud):
Баллы за эти характеристики суммируются.
Если храктеристика присутствует, то для нее баллы рассчитываются в зависимости от количества камер/точек доступа:

| 1-10  | 10-20 | более 20 |
| ----- | ----- | -------- |
|   1   |  1,5  |     2    |

**_Объект культурного наследия:_**                                                                                                  
Проверяем является ли объект культурным наслединем (check_cultural_heritage):
Если является, то +3 балла.

**_Сети:_**                                                                        
Проверяем есть ли сети в проекте (check_net):
Если есть, +1.5 балла.

**_Количество проектировщиков:_**                                                                         
Проверяем, сколько проектировщиков разрабатывали проект (check_authors):
Если проект разрабатывали несколько человек, полученные баллы делятся между ними поровну.

**_Дедлайн:_**                                                                    
Проверяем выполнен ли проект в срок (check_spend_time):                                                 
Дедлайн для проекта расчитывается исходя из количества баллов, которые он набрал. Считается, что 1 балл равен 5 рабочим дням. Например, если проект оценен в 3 балла, он должен быть выполнен за 15 рабочих дней (выходные и праздничные дни не считаются).
Расчитываем дедлайн для проекта (calculate_deadline): от даты начала работы над проектом начинаем отсчет рабочих дней, последний день является дедлайном.
Если проект был выполнен в срок (не позже дня дедлайна), ему присваиваются его баллы без изменений. В другом случае полученные баллы умножаются на понижающий коэффициент 0.9 .

**_Расчет баллов для блок-контейнеров:_**                                                               
Для блок-контейнеров баллы расчитываются по другому: первому разработанному блок-контейнеру присваивается 1 балл. Остальным блок-контейнерам с таким же названием дается по 0.5 балла. Пока что баллы блок-контейнеров не зависят от дедлайна.

**_Расчет баллов за корректировки:_**                                                                    
Также баллы проектировщикам начисляются за корректировки чужих проектов (count_adjusting_points). Баллы за корректировку равны 30 % от баллов за готовый проект(считается, что проект выполнен в срок). Пока эти баллы не учитываются в общей сумме для квартальных расчетов, так как не привязаны ко времени.

### _Распределение баллов по кварталам:_                                                                
Все функции для распределения баллов по кварталам находятся в файле quaterly_points.py.

Для проектов, у которых были расчитаны баллы и у которых указаны даты начала и окончания работы над проектом, проводится распределение баллов по кварталам (calculate_quarter_points):                                                                  
Если проект был выполнен в течение одного квартала - все баллы пойдут в этот квартал.                                              
Если проект был выполнен в течение нескольких кварталов, то баллы будут распределены по кварталам пропорционально времени, потраченному на проект в каждом квартале (считаются календарные дни).

### _Работа с таблицами:_                                                              

Все функции для подключения к таблицам, форматирования, отпрвлениия данных находятся в файле worksheets.py

**_Как работает бот:_**                                                                       

Бот подключается к таблице (пример):                                                                     
```
# сначала проходит аутентификацию
# предварительно в таблице надо дать боту права доступа редактора
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
creds_path = os.path.join(BASE_DIR, 'creds.json')
gc = gspread.service_account(filename=creds_path)

worksheet = gc.open('Таблица проектов').worksheet(f'{dt.now().year}')
```
и дальше выполняет любые действия.                       

**_Важно_** : для бесплатного пользования Google Sheets API установлено ограничение по количеству запросов в минуту, поэтому при выполнении программы после расчета баллов для каждого проектировщика программа ждет 20 секунд, чтобы обойти ограничение.                              

В нашем случает бот берет данные из таблицы "Таблица проектов" с листа, который называется текущим годом, например "2024". При смене года бот копирует весь формат с листа "2024" и создает новый лист с названием "2025", продолжает работу с данными из новой таблицы, когда они появятся.    

Программа производит расчет баллов, формирует новые таблицы с баллами. 
Далее бот подключается к таблице "Премирование2024" (вместо 2024 может быть другой текущий год). Если на данный момент не 2024 год, то бот создает новую таблицу "Премирование(текущий год)" и дает доступ к таблице людям, указанным в фунции connect_to_bonus_ws.                          

Для каждого проектировщика бот создает собственный лист, куда отправляются данные о его проектах. Если для каких-то проектировщиков не надо делать расчет баллов, их фамилии надо перечислить в листе "Настройки" (этот лист создается автоматически) в столбце "Не учитывать". Пример:

|    Не учитывать    |
| ------------------ |
|       Иванов       |
|       Петров       |

Каждый раз при выполнении программы бот перезаписывает данные в таблице "Премирование". 


### _Локальный запуск проекта:_

**_Склонировать репозиторий к себе_**                                                              
```
git@github.com:TatianaSharova/salary_bonus.git
```

**_В директории проекта создать файл .env и заполнить своими данными:_**                                                        
```
TELEGRAM_CHAT_ID = 'ваш id'
TELEGRAM_TOKEN = 'токен бота, который будет слать вам уведомления о проделанной работе'
EMAIL = 'ваша гугл почта'

```

**_В директории проекта поместить ключ от сервисного аккаунта google под названием creds.json:_**                                                 

Например, [здесь рассказывают, как получить этот ключ.](https://codd-wd.ru/instrukciya-po-polucheniyu-klyucha-servisnogo-akkaunta-google-dlya-raboty-s-sheets-api/) (на 3 шаге не забудьте добавить доступ к Google Sheets API)

**_Дать доступ боту к таблице "Таблица проектов":_**                                                 
Для этого настройте доступ в таблице: предоставьте почте, к которой привязан бот, права редактора.
Почту можно узнать в файле creds.json под ключем client_email.

**_Таблица "Премирование":_**                                                         
Вы можете либо сами создать таблицу с названием "Премирование2024" и дать к ней доступ боту, либо в функции worksheets/connect_to_bonus_ws() указать свою почту, чтобы бот пошерил с вами доступ к новой созданной таблице.

**_Запуск через Docker:_**                                                 

1. Находясь в директории проекта выполните сборку образа:
```
docker build -t salary_bonus .
```
2. Запустите контейнер:
```
docker run --name salary_container salary_bonus
```

**_Запуск через cmd:_**                                                 

1. Создать и активировать виртуальное окружение:

Для Linux/macOS:
```
python3 -m venv venv
```
```
source venv/bin/activate
```
Для Windows:
```
python -m venv venv
```
```
source venv/Scripts/activate
```
2. Установить зависимостей из файла requirements.txt:
Для Windows:
```
python -m pip install --upgrade pip
```
```
pip install -r requirements.txt
```
Для Linux:
```
python3 -m pip install --upgrade pip
```
```
pip install -r requirements.txt
```

**_Запустить бот:_**      

Для Windows:
```
python program.py
```
Для Linux:
```
python3 program.py
```


### _Развернуть проект на удаленном сервере с CD:_                                                 

**_Клонировать репозиторий локально:_**                                                 
```
git@github.com:TatianaSharova/foodgram-project-react.git
```
**_Установить на сервере Docker, если его нет:_**                                                 
```
sudo apt install curl                                   - установка утилиты для скачивания файлов
curl -fsSL https://get.docker.com -o get-docker.sh      - скачать скрипт для установки
sh get-docker.sh                                        - запуск скрипта
```

**_Для работы с GitHub Actions необходимо в репозитории в разделе Secrets > Actions создать переменные окружения:_**                            
```
DOCKER_PASSWORD         - пароль от Docker Hub
DOCKER_USERNAME         - логин Docker Hub
HOST                    - публичный IP сервера
USER                    - имя пользователя на сервере
SSH_KEY                 - приватный ssh-ключ
SSH_PASSPHRASE          - пароль для ssh-ключа
ENV                     - полное содержимое файла .env
TELEGRAM_TO             - ID телеграм-аккаунта для посылки сообщения
TELEGRAM_TOKEN          - токен бота, посылающего сообщение
CREDS_JSON              - passphrase который вас попросят придумать при зашифровке файла creds.json
```


**_Зашифровать creds.json:_**                                                 
1. Можете зашифровать файл по [инструкции](https://docs.github.com/ru/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#storing-large-secrets) от GitHub Actions

2. Если у вас нет GnuPG, скачайте его, он бесплатный:                                                                     
Для [Windows](https://www.gpg4win.org/)              
Для [MacOS](https://gnupg.org/download/)

Через графический интерфейс Kleopatra можно выбрать файл, который необходимо зашифровать. Зашифрованный файл появится в той же директории, что и первоначальный файл. При зашифровке вас попросят придумать пароль, его необходимо добавить в Secrets GitHub Actions под именем CREDS_JSON.

Отправьте новый файл в репозиторий:
```
git add creds.json.gpg
git commit -m "Add new secret JSON file"
```

Убедитесь, что скрипт decrypt_creds.sh исполняемый:
```
chmod +x decrypt_creds.sh
git add decrypt_creds.sh
git commit -m "Add new decryption script"
git push
```
-------------------------------------------------------

Готово, при пуше в ветку main проект должен развернуться на сервере. Программа сразу после загрузки на сервер сделает расчет баллов, потом будет делать расчет каждый день в 10:10 утра. После окончания деплоя и каждый раз после выполнения расчета тг-бот будет слать уведомление об этом. Также тг-бот должен присылать уведомление об ошибках, если они случатся во время подсчета баллов.

## План по доработке:                                                 
1. Настроить автоматическое обновление пакета holidays внутри контейнера на сервере.
2. Считать дедлайн для блок-контейнеров (для них ставят общую дату начала и сдачи).
3. Вывести на листы проектировщиков план выполнения проектов в баллах (на данный момент это 12) и какое получается перевыполнение.

я в тг: [tatiana_ssharova](https://t.me/tatiana_ssharova)                                                                       
на [гитхабе](https://github.com/TatianaSharova)
