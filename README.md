# **Salary Bonus**
Сервис для расчета премирования сотрудников проектного отдела. Программа оценивает каждый проект определенным количеством баллов, потом полученные за проект баллы распределяются по месяцам.
Расчет баллов запускается сразу после запуска программы, а потом выполняется каждый день в 10 утра. После окончания расчета и отправки данных в таблицу тг-бот присылает уведомление о завершении расчета. Если в процессе расчета баллов произошла ошибка, тг-бот также уведомляет об этом.

### _Структура проекта:_
```
.
├── src/
│   └── salary_bonus/
│       ├── calculations/                  # расчет баллов и распределений
│       │   ├── additional_archive/         # расчет по архиву доп. работ
│       │   │   ├── counting_points.py      # начисление баллов
│       │   │   ├── process.py              # пайплайн обработки
│       │   │   └── utils.py                # утилиты
│       │   ├── project_archive/            # расчет по архиву проектов
│       │   │   ├── complexity.py           # расчет сложности
│       │   │   ├── counting_points.py      # начисление баллов
│       │   │   └── process.py              # пайплайн обработки
│       │   ├── lead_results.py             # расчеты для ГИП/руководителей группы
│       │   ├── mounth_points.py            # распределение баллов по месяцам
│       │   ├── quaterly_points.py          # распределение баллов по кварталам
│       │   ├── results.py                  # расчет и отправка средних баллов
│       │   └── utils.py                    # общие утилиты расчетов
│       ├── config/
│       │   ├── defaults.py                 # константы
│       │   └── environment.py              # загрузка переменных окружения
│       ├── notification/
│       │   └── telegram/
│       │       └── bot.py                  # уведомления в Telegram
│       ├── worksheets/
│       │   ├── google_sheets_manager.py    # менеджер Google Sheets API
│       │   ├── utils.py                    # утилиты работы с таблицами
│       │   └── worksheets.py               # логика работы с таблицами
│       ├── exceptions.py                   # кастомные исключения
│       ├── logger.py                       # логирование
│       ├── main.py                         # точка входа
│       └── utils.py                        # общие утилиты проекта
...
```                                       

### _Локальный запуск проекта:_

**_В директории проекта создать файл .env и заполнить своими данными на примере файла .env.example:_**                                                        
```
TELEGRAM_CHAT_ID = id чата
TELEGRAM_TOKEN = токен бота, который будет слать вам уведомления о проделанной работе/ошибках
EMAILS = список почт через пробел, которые нужно добавить в таблицу
ENDPOINT_ATTENDANCE_SHEET = ссылка на таблицу с табелем посещаемости офиса
```

**_В директории проекта поместить ключ от сервисного аккаунта google под названием creds.json:_**                                                 

Например, [здесь рассказывают, как получить этот ключ.](https://codd-wd.ru/instrukciya-po-polucheniyu-klyucha-servisnogo-akkaunta-google-dlya-raboty-s-sheets-api/) (на 3 шаге не забудьте добавить доступ к Google Sheets API)

**_Дать доступ боту к таблице "Таблица проектов":_**                                                 
Для этого настройте доступ в таблице: предоставьте почте, к которой привязан бот, права редактора.
Почту можно узнать в файле creds.json под ключем client_email.

**_Таблица "Премирование":_**                                                         
Создастся автоматически ботом, бот даст доступ к таблице тем людям, чьи почты указаны в EMAILS в .env. Уведомление о предоставлении доступа будут разосланы на почты.

**_Запуск через Docker:_**                                                 

1. Находясь в директории проекта выполните:
```
docker compose up --build
```

**_Запуск через терминал:_**                                                 

1. Создать и активировать виртуальное окружение:

Для Linux/macOS:
```
python3 -m venv venv
```
```
source venv/bin/activate
```
Для Windows:
```
python -m venv venv
```
```
source venv/Scripts/activate
```
2. Установить зависимостей из файла requirements.txt:
Для Windows:
```
python -m pip install --upgrade pip
```
```
pip install -r requirements.txt
```
Для Linux:
```
python3 -m pip install --upgrade pip
```
```
pip install -r requirements.txt
```

**_Запустить бот:_**      

Для Windows:
```
python src/salary_bonus/main.py
```
Для Linux:
```
python3 src/salary_bonus/main.py
```


### _Развернуть проект на удаленном сервере с CD:_                                                 

**_Установить на сервере Docker, если его нет:_**                                                 
```
sudo apt install curl                                   - установка утилиты для скачивания файлов
curl -fsSL https://get.docker.com -o get-docker.sh      - скачать скрипт для установки докера
sh get-docker.sh                                        - запуск скрипта
```

**_Для работы с GitHub Actions необходимо в репозитории в разделе Secrets > Actions создать переменные окружения:_**                            
```
DOCKER_PASSWORD         - пароль от Docker Hub
DOCKER_USERNAME         - логин Docker Hub
HOST                    - публичный IP сервера
USER                    - имя пользователя на сервере
SSH_KEY                 - приватный ssh-ключ
SSH_PASSPHRASE          - пароль для ssh-ключа
ENV                     - полное содержимое файла .env
TELEGRAM_TO             - ID телеграм-аккаунта для посылки сообщения
TELEGRAM_TOKEN          - токен бота, посылающего сообщение
CREDS_JSON              - passphrase который вас попросят придумать при зашифровке файла creds.json
```


**_Зашифровать creds.json:_**                                                 
1. Можете зашифровать файл по [инструкции](https://docs.github.com/ru/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#storing-large-secrets) от GitHub Actions

2. Если у вас нет GnuPG, скачайте его, он бесплатный:                                                                     
Для [Windows](https://www.gpg4win.org/)              
Для [MacOS](https://gnupg.org/download/)

Через графический интерфейс Kleopatra можно выбрать файл, который необходимо зашифровать. Зашифрованный файл появится в той же директории, что и первоначальный файл. При зашифровке вас попросят придумать пароль, его необходимо добавить в Secrets GitHub Actions под именем CREDS_JSON.

Отправьте новый файл в репозиторий:
```
git add creds.json.gpg
git commit -m "Add new secret JSON file"
```

Убедитесь, что скрипт decrypt_creds.sh исполняемый:
```
chmod +x decrypt_creds.sh
git add decrypt_creds.sh
git commit -m "Add new decryption script"
git push
```
-------------------------------------------------------

Готово, при пуше в ветку main проект должен развернуться на сервере. Программа сразу после загрузки на сервер сделает расчет баллов, потом будет делать расчет ежедневно в 10:00 утра. Также каждые полгода будет обновляться пакет holidays для корректного подсчета дедлайна.
После окончания деплоя и каждый раз после выполнения расчета тг-бот будет слать уведомление об этом. Также тг-бот должен присылать уведомление об ошибках, если они случатся во время подсчета баллов.



### _Как происходит расчет баллов для проектов из архива проектов:_                                                          

Для расчета баллов программа берет данные из основной рабочей таблицы с архивом проектов "Таблица проектов".

Полученные баллы зависят от нескольких критериев: сложность проекта, тип объекта, количество направлений АСПТ (и другие АПТ), наличие ПС, ОС, СОУЭ, сетей, автоматизации систем вентиляции, наличие СОТ(количество камер), наличие СКУД(количество точек доступа), является ли объект культурным наследием, выполнен ли проект до дедлайна.

Для начала проект проверяется на наличие необходимых для расчета характеристик: наименование объекта, шифр исп, дата начала проекта, сложность. Если какая-то из этих характеристик не заполнена, расчет баллов для проекта не осуществляется. Остальные критерии, перечисленные выше, являются добавочными и могут быть не заполнены.

Если необходимые характеристики заполнены, переходим к расчету баллов:

**_Сложность проекта:_**                                                         

Определяется автоматически с помощью алгоритма (можно найти в файле complexity.py). Алгоритм учитывает тип объекта, количество направлений и модулей, оборудование, наличие ПС, ОС, СОУЭ. Минимальная сложность 1, максимальная 5.                                       

Если сложность рассчитана некорректно, ГИП может её поменять в таблице "Премирование". Для этого в столбце "Корректировка сложности" нужно записать новое значение сложности. При следующем расчете баллы за проект будут считаться, учитывая сложность, поставленную ГИПом. Ячейки с учтенными корректировками окрашиваются в желтый цвет, чтобы можно было определить, стоят ли новые баллы за проект или старые. 

**_Количество направлений:_**                                                          
Проверяем количество направлений (функция check_amount_directions)
Баллы зависят от сложности проекта и количества направлений. Зависимость показана в таблице:

| Сложность  | 1-2 | 3-4 | 5-6 | 7-8 | 9-12 | 13-20 |
| ---------- | --- | --- | --- | --- | ---- | ----- |
|     1      |  1  |  1  | 1,5 |  2  |  2,5 |   3   |
|     2      |  1  | 1,5 |  2  |  2  |  3   |  3,5  |
|     3      | 1,5 |  2  | 2,5 | 2,5 |  3,5 |   4   |
|     4      |  2  | 2,5 |  3  |  3  |  4   |   5   |
|     5      |  4  |  4  |  4  |  5  |  6   |   8   |

Если направлений больше 20, баллы вычисляются по формуле:                                
(количество направлений/(8.5-сложность) + сложность/2)

**_ПС, СОУЭ, ОС, автоматизация систем вентиляции:_**                                                        
Проверяем наличие ПС, СОУЭ, ОС, автоматизации систем вентиляции (функция check_square):
Баллы за эти характеристики суммируются.
Если характеристика присутствует, то для нее баллы рассчитываются исходя из сложности и площади защищаемых помещений:

| Сложность  | до 400 м^2 | 400-1000 | 1000-3000 | 3000-10000 | более 10000 |
| ---------- | ---------- | -------- | --------- | ---------- | ----------- |
|     1      |     1      |    1,5   |     2     |     2,5    |      3      |
|     2      |     2      |    2,5   |     3     |     3,5    |      5      |
|     3      |     2      |     3    |    3,5    |      4     |      8      |
|     4      |     3      |     4    |    4,5    |      5     |      10     |
|     5      |     4      |    4,5   |     5     |     5,5    |      12     |

**_СОТ, СКУД:_**                                                 
Проверяем наличие СОТ, СКУД (функция check_sot_skud):
Баллы за эти характеристики суммируются.
Если характеристика присутствует, то для нее баллы рассчитываются в зависимости от количества камер/точек доступа:

| 1-10  | 10-20 | более 20 |
| ----- | ----- | -------- |
|   1   |  1,5  |     2    |

**_Объект культурного наследия:_**                                                                                                  
Проверяем является ли объект культурным наслединем (check_cultural_heritage):
Если является, то +3 балла.

**_Сети:_**                                                                        
Проверяем есть ли сети в проекте (check_net):
Если есть, +1.5 балла.

**_Количество проектировщиков:_**                                                                         
Проверяем, сколько проектировщиков разрабатывали проект (check_authors):
Если проект разрабатывали несколько человек, полученные баллы делятся между ними поровну.

**_Дедлайн:_**                                                                    
Проверяем выполнен ли проект в срок (check_spend_time):                                                 
Дедлайн для проекта рассчитывается исходя из количества баллов, которые он набрал. Считается, что 1 балл равен 5 рабочим дням. Например, если проект оценен в 3 балла, он должен быть выполнен за 15 рабочих дней (выходные и праздничные дни не считаются).
Рассчитываем дедлайн для проекта (calculate_deadline): от даты начала работы над проектом начинаем отсчет рабочих дней, последний день является дедлайном.
Если проект был выполнен в срок (не позже дня дедлайна), ему присваиваются его баллы без изменений. В другом случае полученные баллы умножаются на понижающий коэффициент 0.9 .
                                                                                             
Дедлайн можно продлить: для этого в таблице "Таблица проектов", в строке проекта в столбце "Продление дедлайна" нужно ввести количество дней, на которые сместится дедлайн.


**_Расчет баллов и дедлайна для блок-контейнеров:_**                                                               
Для блок-контейнеров баллы рассчитываются немного иначе.                                                      
Если была выполнена группа блок-контейнеров (у которых совпадает название в столбце "Наименование объекта"), то первый разработанный блок-контейнер получает полное количество подсчитанных баллов. Остальным блок-контейнерам с таким же названием дается по половине баллов от баллов первого контейнера.
Для группы блок-контейнеров дедлайн рассчитывается по формуле: 4 + (количество блок-контейнеров).                                     
То есть 5 дней на разработку первого контейнера и по 1 дню на следующие.                                                              
Если дедлайн был просрочен, то полученные баллы умножаются на понижающий коэффициент = 0.9 .
                                                                    
Если был выполнен единственный блок-контейнер, то баллы и дедлайн для него считаются, как для обычных проектов.                                   


**_Расчет баллов за корректировки:_**                                                                    
Также баллы проектировщикам начисляются за корректировки чужих проектов (count_adjusting_points). Баллы за корректировку равны 30 % от баллов за готовый проект(считается, что проект выполнен в срок).                                                                                       
Чтобы учесть, что проект является корректировкой, необходимо в стоблце "Является корректировкой" поставить значение "Да". Дедлайн для корректировок рассчитывается, как для обычных проектов.

### _Как происходит расчет баллов за доп. проекты:_ 
Баллы считаются для строк с заполненными полями "Наименование объекта", "Тип работы", "Дата начала проекта". Если тип работы не из списка допустимых, расчет не выполняется.

Допустимые типы и базовые баллы:
- "Расстановка оборудования" — +0.2
- "Подготовка спецификации" — +0.2
- "ГР Модульная установка" — начисление по количеству направлений:
  - до 10 — +0.2
  - 11–20 — +0.5
  - больше 20 — +1
- "ГР Модульная установка 500+" — как "ГР Модульная установка" +1.5
- "ГР Централизованная установка" — по количеству направлений:
  - до 15 — +1.5
  - больше 15 — +2

Если указан дедлайн, то применяется проверка выполения проекта в срок (1 балл = 5 рабочих дней, при просрочке полученные баллы умножаются на коэффициент 0.9).

### _Распределение баллов по месяцам:_                                                                
Все функции для распределения баллов по месяцам находятся в файле mounth_points.py.

Баллы за проект начисляются в тот месяц, в который проект был окончен.
В месяц попадает сумма баллов, заработанных в этом месяце за дополнительные работы и проекты из архива проектов.


**_Как работает бот:_**                                                                       

Бот подключается к таблице (пример):                                                                     
```
# сначала проходит аутентификацию
# предварительно в таблице надо дать боту права доступа редактора
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
creds_path = os.path.join(BASE_DIR, 'creds.json')
gc = gspread.service_account(filename=creds_path)

worksheet = gc.open('Таблица проектов').worksheet(f'{dt.now().year}')
```
и дальше выполняет любые действия.                       

**_Важно_** : для бесплатного пользования Google Sheets API установлено ограничение по количеству запросов в минуту, поэтому при выполнении программы после расчета баллов для каждого проектировщика программа ждет 10 секунд, чтобы обойти ограничение (и 5 секунд при первом создании листка проектировщика).                              

В нашем случает бот берет данные из таблицы "Таблица проектов" с листа, который называется текущим годом, например "2024". При смене года бот копирует весь формат с листа "2024" и создает новый лист с названием "2025", продолжает работу с данными, взятыми с нового листа.    

Программа производит расчет баллов, формирует новые таблицы с баллами. 
Далее бот подключается к таблице "Премирование2024" (вместо 2024 может быть другой текущий год). Если год сменился, то бот создает новую таблицу "Премирование(текущий год)" и дает доступ к таблице людям, указанным в EMAILS в .env.                          

Для каждого проектировщика бот создает собственный лист, куда отправляются данные о его проектах. На листе "Настройки" (он создается автоматически) нужно заполнить 3 столбца: "Инженеры" (для кого делать расчет), "Руководители группы" (привязаны к инженерам), "ГИП" (один человек). Для инженеров делается расчет баллов, для руководителей группы считаются итоги по их группе, для ГИП — итоги по всем разработчикам. Пример:

| Инженеры | Руководители группы | ГИП      |
| -------- | ------------------- | -------- |
| Иванов   | Петров              | Сидоров  |
| Смирнов  | Кузнецова           |          |   

Для получения информации о рабочих часах проектировщика бот подключается к таблице "Табель Проектный отдел".
Для корректировок сложности бот подключается к листу проектировщика и берет информацию оттуда.



                                                                                                       

Каждый раз при выполнении программы бот обрабатывает все данные и перезаписывает предыдущие данные в таблице "Премирование".  
